<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-piechart-outlabels@1.1.4/dist/chartjs-plugin-piechart-outlabels.min.js"></script>

    <title>판매 현황</title>
    <style>
        @import url('//fonts.googleapis.com/earlyaccess/notosanskr.css');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'notosanskr', sans-serif;
            min-height: 100vh;
            color: #1a202c;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 50%, rgba(221, 221, 221, 0.3), transparent 50%),
            radial-gradient(circle at 80% 80%, rgba(119, 119, 119, 0.2), transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        .stats-section {
            margin-top: 7vh;
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            max-width: 1800px;
            margin-left: auto;
            margin-right: auto;
        }

        .stats-header {
            margin-bottom: 24px;
        }

        .stats-title {
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .weekly-comparison {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.5);
            margin-bottom: 32px;
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .comparison-title {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .period-info {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 600;
        }

        .table-container {
            border-radius: 12px;
            overflow-x: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1rem;
            background: white;
            min-width: 800px;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        th {
            padding: 12px 16px;
            text-align: center;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            white-space: nowrap;
        }

        th:first-child {
            min-width: 100px;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .before-last-week-row {
            background-color: #f9fafb;
        }

        .before-last-week-row td {
            color: #6b7280;
        }

        .last-week-row {
            background: #f9fafb;
        }

        .this-week-row {
            background: #f0f4ff;
        }

        .increase-row {
            background: #fef3c7;
            font-weight: 700;
        }

        .increase-positive {
            color: #059669;
        }

        .increase-negative {
            color: #dc2626;
        }

        .increase-zero {
            color: #6b7280;
        }

        .price-text {
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .year-selector {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.5);
            margin-bottom: 24px;
        }

        .year-buttons {
            display: flex;
            gap: 12px;
        }

        .btn-year {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: white;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-year.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .btn-year:hover:not(.active) {
            background: #f8f9ff;
        }

        .btn-product-list {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-product-list:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .product-list-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .product-list-modal-content {
            background: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 1200px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .product-list-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-list-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .product-list-modal-body {
            padding: 32px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .product-list-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            background: white;
        }

        .product-list-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .product-list-table th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .product-list-table td {
            padding: 16px;
            border: 1px solid #e5e7eb;
            text-align: left;
            vertical-align: middle;
        }

        .product-list-table tbody tr {
            transition: background-color 0.2s;
        }

        .product-list-table tbody tr:hover {
            background: rgba(102, 126, 234, 0.03);
        }

        .product-name-cell {
            display: flex;
            text-align: left;
        }

        .product-name-text {
            font-weight: 600;
            color: #1a202c;
            font-size: 1rem;
            display: block;
        }

        .featured-cell {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
        }

        .featured-icon {
            color: #f59e0b;
            font-size: 1.2rem;
        }

        .featured-checkbox-input {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .no-product-line {
            color: #9ca3af;
            font-style: italic;
        }

        .client-section {
            margin-bottom: 32px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        }

        .client-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .client-name {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1a202c;
        }

        .client-country {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 4px 12px;
            background: #f3f4f6;
            border-radius: 20px;
        }

        .client-total {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.5);
            margin-bottom: 32px;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }

        canvas {
            max-height: 350px;
        }

        .client-section {
            margin-bottom: 32px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        }

        .client-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .client-name {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1a202c;
        }

        .client-country {
            font-size: 0.875rem;
            color: #6b7280;
            padding: 4px 12px;
            background: #f3f4f6;
            border-radius: 20px;
        }

        .client-total {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .btn-detail {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .btn-detail:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }

        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            margin: 3% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 20px 20px 0 0;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .close {
            color: white;
            font-size: 32px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.3s;
            line-height: 1;
            padding: 0;
            background: none;
            border: none;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close:hover {
            transform: rotate(90deg);
            opacity: 0.8;
        }

        .modal-body {
            padding: 32px;
            max-height: calc(85vh - 100px);
            overflow-y: auto;
        }

        .child-client-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        .child-client-card:last-child {
            margin-bottom: 0;
        }

        .child-client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.15);
        }

        .child-client-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1a202c;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .child-client-total {
            font-size: 1.125rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        #productFilter {
            padding: 8px 16px;
            border-radius: 8px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        #productFilter:hover {
            background: #f8f9ff;
            border-color: #764ba2;
        }

        #productFilter:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* 옵션 항목 스타일 */
        #productFilter option {
            padding: 10px;
            font-weight: 600;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="stats-section">
        <div class="stats-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2 class="stats-title">판매 현황</h2>
                <button class="btn-product-list" onclick="openProductListModal()">
                    제품 목록
                </button>
            </div>
        </div>

        <!-- 주간 판매 비교 -->
        <div class="weekly-comparison">
            <div class="comparison-header">
                <span class="comparison-title">주간 판매량 비교</span>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <span class="period-info" id="periodInfo"></span>
                </div>
            </div>
            <div class="table-container">
                <table id="comparisonTable">
                    <thead>
                    <tr>
                        <th>구분</th>
                        <!-- 제품 컬럼이 동적으로 추가됩니다 -->
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 주간 비교 차트 -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3 class="chart-title">주간 누적 판매량 비교</h3>
                <canvas id="weeklyComparisonChart"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">제품별 증가량</h3>
                <canvas id="weeklyChangeChart"></canvas>
            </div>
        </div>

        <!-- 월별 판매 추이 -->
        <div class="weekly-comparison">
            <div class="comparison-header">
                <h3 class="comparison-title">12개월 주요 제품 판매 추이</h3>
                <div class="period-info" id="monthlyPeriodInfo"></div>
            </div>
            <div class="chart-container" style="height: 450px;">
                <canvas id="monthlyTrendChart"></canvas>
            </div>
        </div>

        <!-- 연간 거래처별 판매 현황 -->
        <div class="year-selector">
            <div class="year-buttons" id="yearButtons"></div>
        </div>

        <!-- 금년 제품별 누적 판매량 -->
        <div class="weekly-comparison">
            <div class="comparison-header">
                <h3 class="comparison-title">금년 제품별 누적 판매량</h3>
                <div class="period-info" id="yearlyTotalPeriod"></div>
            </div>
            <div class="table-container">
                <table id="yearlyTotalTable">
                    <thead>
                    <tr>
                        <th>제품명</th>
                        <th>제품코드</th>
                        <th>누적 판매량</th>
                        <th>누적 판매액 (원화)</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- 연간 누적 차트 -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3 class="chart-title">제품별 판매량 분포</h3>
                <div id="yearlyPieChart" style="width: 100%;  height: 400px;"></div>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">제품별 판매액 (원화)</h3>
                <div id="yearlyBarChart" style="width: 100%; height: 400px;"></div>
            </div>
        </div>
        <div id="yearlyStats"></div>
    </div>
</div>

<div id="childClientsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="modalParentName"></h2>
            <button class="close" onclick="closeChildClientsModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalChildClientsBody">
        </div>
    </div>
</div>

<div id="productListModal" class="product-list-modal">
    <div class="product-list-modal-content">
        <div class="product-list-modal-header">
            <h2 class="product-list-modal-title">제품 목록</h2>
            <button class="close" onclick="closeProductListModal()">×</button>
        </div>
        <div class="product-list-modal-body" id="productListModalBody">
            <div style="text-align: center; color: #6b7280; padding: 40px;">
                제품 목록을 불러오는 중...
            </div>
        </div>
    </div>
</div>

<div id="sidebar-container"></div>
<script>
    fetch("/infra/sidebar.html")
        .then(res => res.text())
        .then(html => {
            document.getElementById("sidebar-container").innerHTML = html;

            const sidebarMenu = document.querySelector(".left-slide-menu");

            if (sidebarMenu) {
                console.log("✅ 사이드바 로드 완료");
            } else {
                console.warn("⚠️ 사이드바 요소를 찾을 수 없습니다.");
            }
        })
</script>

<script>
    const API_BASE_URL = '/api/sales-stats';
    const PRODUCTS_API_URL = '/api/products';
    const CLIENTS_API_URL = '/api/clients';
    let selectedYear = new Date().getFullYear();
    let weeklyComparisonChart = null;
    let weeklyChangeChart = null;
    let allClients = [];
    let monthlyTrendChart = null;
    let allProducts = [];

    document.addEventListener('DOMContentLoaded', async function () {
        await loadProducts();
        await loadClients();
        initYearButtons();
        await loadWeeklyComparison();
        await loadMonthlySales();
        await loadYearlySales(selectedYear);
    });

    async function loadProducts() {
        try {
            const response = await fetch(PRODUCTS_API_URL);
            if (!response.ok) throw new Error('제품 목록을 불러오는데 실패했습니다');
            allProducts = await response.json();
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function loadClients() {
        try {
            const response = await fetch(CLIENTS_API_URL);
            if (!response.ok) throw new Error('거래처 목록을 불러오는데 실패했습니다');
            allClients = await response.json();
            console.log('Clients loaded:', allClients.length);
        } catch (error) {
            console.error('Error loading clients:', error);
        }
    }

    function initYearButtons() {
        const currentYear = new Date().getFullYear();
        const years = [currentYear - 1, currentYear];
        const yearButtons = document.getElementById('yearButtons');

        yearButtons.innerHTML = years.map(year => `
            <button class="btn-year ${year === selectedYear ? 'active' : ''}"
                    onclick="selectYear(${year})">
                ${year}년
            </button>
        `).join('');
    }

    function selectYear(year) {
        selectedYear = year;
        initYearButtons();
        loadYearlySales(year);
    }

    async function loadWeeklyComparison() {
        try {
            const currentYear = new Date().getFullYear();

            // 주간 정보와 연간 누적 데이터 가져오기
            const [beforeLastWeekResponse, lastWeekResponse, thisWeekResponse, yearlyResponse] = await Promise.all([
                fetch(`${API_BASE_URL}/weekly/before-last`),
                fetch(`${API_BASE_URL}/weekly/last`),
                fetch(`${API_BASE_URL}/weekly/current`),
                fetch(`${API_BASE_URL}/yearly/${currentYear}`)
            ]);

            if (!beforeLastWeekResponse.ok || !lastWeekResponse.ok || !thisWeekResponse.ok) {
                throw new Error('데이터 로드 실패');
            }

            const beforeLastWeekData = await beforeLastWeekResponse.json();
            const lastWeekData = await lastWeekResponse.json();
            const thisWeekData = await thisWeekResponse.json();

            let beforeLastWeekCumulative, lastWeekCumulative, thisWeekCumulative;

            if (yearlyResponse.ok) {
                const yearlyData = await yearlyResponse.json();

                // 연간 전체 데이터에서 누적 계산
                const yearlyProducts = calculateCumulativeFromClientSales(yearlyData.clientSales);
                const thisWeekProducts = calculateProductSalesMap(thisWeekData.productSales);
                const lastWeekProducts = calculateProductSalesMap(lastWeekData.productSales);

                // 이번주 누적 = 연간 전체
                thisWeekCumulative = yearlyProducts;

                // 지난주 누적 = 연간 전체 - 이번주 판매량
                lastWeekCumulative = yearlyProducts.map(product => {
                    const thisWeekProduct = thisWeekProducts.get(product.productCode);
                    const thisWeekQty = thisWeekProduct ? thisWeekProduct.quantity : 0;

                    return {
                        ...product,
                        quantity: product.quantity - thisWeekQty
                    };
                });

                // 지지난주 누적 = 연간 전체 - 이번주 판매량 - 지난주 판매량
                beforeLastWeekCumulative = yearlyProducts.map(product => {
                    const thisWeekProduct = thisWeekProducts.get(product.productCode);
                    const lastWeekProduct = lastWeekProducts.get(product.productCode);
                    const thisWeekQty = thisWeekProduct ? thisWeekProduct.quantity : 0;
                    const lastWeekQty = lastWeekProduct ? lastWeekProduct.quantity : 0;

                    return {
                        ...product,
                        quantity: product.quantity - thisWeekQty - lastWeekQty
                    };
                });
            } else {
                // 연간 데이터도 없으면 주간 데이터 사용
                beforeLastWeekCumulative = beforeLastWeekData.productSales;
                lastWeekCumulative = lastWeekData.productSales;
                thisWeekCumulative = thisWeekData.productSales;
            }

            document.getElementById('periodInfo').innerHTML = `
            지지난주: ${formatDate(beforeLastWeekData.weekStart)} ~ ${formatDate(beforeLastWeekData.weekEnd)} /
            지난주: ${formatDate(lastWeekData.weekStart)} ~ ${formatDate(lastWeekData.weekEnd)} /
            이번주: ${formatDate(thisWeekData.weekStart)} ~ ${formatDate(thisWeekData.weekEnd)}
            <span style="font-size: 0.75em; color: #9CA3AF; margin-left: 8px;">(판매량: ${currentYear}년 1월 1일부터 누적)</span>
        `;

            renderWeeklyComparison(beforeLastWeekCumulative, lastWeekCumulative, thisWeekCumulative);
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // clientSales에서 제품별 누적 데이터 계산
    function calculateCumulativeFromClientSales(clientSales) {
        const productMap = new Map();

        clientSales.forEach(client => {
            client.productSales.forEach(product => {
                const amountKRW = product.totalAmountKRW || product.totalAmount;

                if (productMap.has(product.productCode)) {
                    const existing = productMap.get(product.productCode);
                    existing.quantity += product.quantity;
                    existing.totalAmount += amountKRW;
                    existing.totalAmountKRW += amountKRW;
                } else {
                    productMap.set(product.productCode, {
                        productId: product.productId,
                        productCode: product.productCode,
                        productName: product.productName,
                        quantity: product.quantity,
                        totalAmount: amountKRW,
                        totalAmountKRW: amountKRW
                    });
                }
            });
        });

        return Array.from(productMap.values());
    }

    // 제품 판매 데이터를 Map으로 변환
    function calculateProductSalesMap(productSales) {
        const map = new Map();
        productSales.forEach(product => {
            map.set(product.productCode, product);
        });
        return map;
    }

    /**
     * 주간 판매 데이터를 isFeatured와 productLine 기준으로 그룹화
     */
    function groupWeeklySalesData(salesData) {
        // allProducts를 productCode로 빠르게 찾기 위한 Map 생성
        const productMap = new Map();
        allProducts.forEach(product => {
            productMap.set(product.productCode, product);
        });

        // 그룹별 데이터 저장
        const groups = new Map();
        let othersTotalQuantity = 0;
        let othersAmountKRW = 0;

        salesData.forEach(sale => {
            const product = productMap.get(sale.productCode);

            if (!product) {
                // 제품 정보가 없으면 기타로 분류
                othersTotalQuantity += sale.quantity;
                othersAmountKRW += (sale.totalAmountKRW || sale.totalAmount || 0);
                return;
            }

            if (product.isFeatured) {
                // 주요 제품
                if (product.productLine) {
                    // productLine이 있으면 그룹화
                    const groupKey = product.productLine.name;
                    if (!groups.has(groupKey)) {
                        groups.set(groupKey, {
                            name: groupKey,
                            isGroup: true,
                            quantity: 0,
                            totalAmountKRW: 0
                        });
                    }
                    const group = groups.get(groupKey).quantity += sale.quantity;
                    group.quantity += sale.quantity;
                    group.totalAmountKRW += (sale.totalAmountKRW || sale.totalAmount || 0);
                } else {
                    // productLine이 없으면 개별 표시
                    groups.set(product.productCode, {
                        name: sale.productName,
                        code: product.productCode,
                        isGroup: false,
                        quantity: sale.quantity,
                        totalAmountKRW: (sale.totalAmountKRW || sale.totalAmount || 0)
                    });
                }
            } else {
                // 주요 제품이 아니면 기타로 합산
                othersTotalQuantity += sale.quantity;
                othersAmountKRW += (sale.totalAmountKRW || sale.totalAmount || 0);
            }
        });

        // 주요 제품 중 판매량이 0인 것도 추가
        allProducts.forEach(product => {
            if (product.isFeatured) {
                if (product.productLine) {
                    const groupKey = product.productLine.name;
                    if (!groups.has(groupKey)) {
                        groups.set(groupKey, {
                            name: groupKey,
                            isGroup: true,
                            quantity: 0,
                            totalAmountKRW: 0
                        });
                    }
                } else {
                    if (!groups.has(product.productCode)) {
                        groups.set(product.productCode, {
                            name: product.name,
                            code: product.productCode,
                            isGroup: false,
                            quantity: 0,
                            totalAmountKRW: 0
                        });
                    }
                }
            }
        });

        // 기타 추가
        if (othersTotalQuantity > 0 || groups.size > 0) {
            groups.set('__others__', {
                name: '기타',
                isGroup: true,
                quantity: othersTotalQuantity,
                totalAmountKRW: othersAmountKRW
            });
        }

        return Array.from(groups.values());
    }

    function renderWeeklyComparison(beforeLastWeekProducts, lastWeekProducts, thisWeekProducts) {
        const table = document.getElementById('comparisonTable');
        const thead = table.querySelector('thead tr');
        const tbody = table.querySelector('tbody');

        // 데이터 그룹화
        const beforeLastWeekGroups = groupWeeklySalesData(beforeLastWeekProducts);
        const lastWeekGroups = groupWeeklySalesData(lastWeekProducts);
        const thisWeekGroups = groupWeeklySalesData(thisWeekProducts);

        // 모든 그룹 키 수집 (합집합)
        const allGroupKeys = new Set();
        beforeLastWeekGroups.forEach(g => allGroupKeys.add(g.name));
        lastWeekGroups.forEach(g => allGroupKeys.add(g.name));
        thisWeekGroups.forEach(g => allGroupKeys.add(g.name));

        // 그룹별 데이터 병합
        const products = Array.from(allGroupKeys).map(groupName => {
            const beforeLastWeek = beforeLastWeekGroups.find(g => g.name === groupName);
            const lastWeek = lastWeekGroups.find(g => g.name === groupName);
            const thisWeek = thisWeekGroups.find(g => g.name === groupName);

            return {
                name: groupName,
                beforeLastWeekQty: beforeLastWeek?.quantity || 0,
                lastWeekQty: lastWeek?.quantity || 0,
                thisWeekQty: thisWeek?.quantity || 0
            };
        });

        // "기타"를 마지막으로 이동
        const othersIndex = products.findIndex(p => p.name === '기타');
        if (othersIndex > -1) {
            const others = products.splice(othersIndex, 1)[0];
            products.push(others);
        }

        // 각 행의 합계 계산
        const beforeLastWeekTotal = products.reduce((sum, p) => sum + p.beforeLastWeekQty, 0);
        const lastWeekTotal = products.reduce((sum, p) => sum + p.lastWeekQty, 0);
        const thisWeekTotal = products.reduce((sum, p) => sum + p.thisWeekQty, 0);

        const increaseFromBeforeLastTotal = thisWeekTotal - beforeLastWeekTotal;
        const increaseFromLastTotal = thisWeekTotal - lastWeekTotal;

        // 헤더 생성
        thead.innerHTML = '<th>구분</th>' +
            products.map(p => `<th>${p.name}</th>`).join('') +
            '<th>총 판매량</th>';

        // 판매량 행들 생성
        const qtyRows = `
            <tr class="before-last-week-row" style="background-color: #f9fafb;">
                <td>지지난주</td>
                ${products.map(p => `<td>${p.beforeLastWeekQty.toLocaleString()}</td>`).join('')}
                <td><strong>${beforeLastWeekTotal.toLocaleString()}</strong></td>
            </tr>
            <tr class="last-week-row">
                <td>지난주</td>
                ${products.map(p => `<td>${p.lastWeekQty.toLocaleString()}</td>`).join('')}
                <td><strong>${lastWeekTotal.toLocaleString()}</strong></td>
            </tr>
            <tr class="this-week-row">
                <td>이번주</td>
                ${products.map(p => `<td>${p.thisWeekQty.toLocaleString()}</td>`).join('')}
                <td><strong>${thisWeekTotal.toLocaleString()}</strong></td>
            </tr>
            <tr class="increase-row">
                <td>전주 대비 증가</td>
                ${products.map(p => {
                const increase = p.thisWeekQty - p.lastWeekQty;
                const className = increase > 0 ? 'increase-positive' :
                    increase < 0 ? 'increase-negative' : 'increase-zero';
                const sign = increase > 0 ? '+' : '';
                return `<td class="${className}">${sign}${increase.toLocaleString()}</td>`;
            }).join('')}
                <td class="${increaseFromLastTotal > 0 ? 'increase-positive' : increaseFromLastTotal < 0 ? 'increase-negative' : 'increase-zero'}">
                    <strong>${increaseFromLastTotal > 0 ? '+' : ''}${increaseFromLastTotal.toLocaleString()}</strong>
                </td>
            </tr>
            <tr class="increase-row" style="background-color: #f9fafb;">
                <td>전전주 대비 증가</td>
                ${products.map(p => {
                const increase = p.thisWeekQty - p.beforeLastWeekQty;
                const className = increase > 0 ? 'increase-positive' :
                    increase < 0 ? 'increase-negative' : 'increase-zero';
                const sign = increase > 0 ? '+' : '';
                return `<td class="${className}">${sign}${increase.toLocaleString()}</td>`;
            }).join('')}
                <td class="${increaseFromBeforeLastTotal > 0 ? 'increase-positive' : increaseFromBeforeLastTotal < 0 ? 'increase-negative' : 'increase-zero'}">
                    <strong>${increaseFromBeforeLastTotal > 0 ? '+' : ''}${increaseFromBeforeLastTotal.toLocaleString()}</strong>
                </td>
            </tr>
        `;

        tbody.innerHTML = qtyRows;

        // 차트 렌더링
        renderWeeklyCharts(products);
    }

    function renderWeeklyCharts(products) {
        // 주간 판매량 비교 차트
        const comparisonCtx = document.getElementById('weeklyComparisonChart').getContext('2d');
        if (weeklyComparisonChart) {
            weeklyComparisonChart.destroy();
        }

        weeklyComparisonChart = new Chart(comparisonCtx, {
            type: 'bar',
            data: {
                labels: products.map(p => p.name),
                datasets: [
                    {
                        label: '지지난주',
                        data: products.map(p => p.beforeLastWeekQty),
                        backgroundColor: 'rgba(156, 163, 175, 0.7)',
                        borderColor: 'rgba(156, 163, 175, 1)',
                        borderWidth: 1
                    },
                    {
                        label: '지난주',
                        data: products.map(p => p.lastWeekQty),
                        backgroundColor: 'rgba(251, 146, 60, 0.7)',
                        borderColor: 'rgba(251, 146, 60, 1)',
                        borderWidth: 1
                    },
                    {
                        label: '이번주',
                        data: products.map(p => p.thisWeekQty),
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    datalabels: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // 제품별 증가량 차트
        const changeCtx = document.getElementById('weeklyChangeChart').getContext('2d');
        if (weeklyChangeChart) {
            weeklyChangeChart.destroy();
        }

        // 전주 대비 증가량 계산
        const changesFromLast = products.map(p => p.thisWeekQty - p.lastWeekQty);
        // 전전주 대비 증가량 계산
        const changesFromBeforeLast = products.map(p => p.thisWeekQty - p.beforeLastWeekQty);

        weeklyChangeChart = new Chart(changeCtx, {
            type: 'bar',
            data: {
                labels: products.map(p => p.name),
                datasets: [
                    {
                        label: '전전주 대비',
                        data: changesFromBeforeLast,
                        backgroundColor: changesFromBeforeLast.map(v =>
                            v > 0 ? 'rgba(34, 197, 94, 0.7)' :
                                v < 0 ? 'rgba(239, 68, 68, 0.7)' :
                                    'rgba(156, 163, 175, 0.7)'
                        ),
                        borderColor: changesFromBeforeLast.map(v =>
                            v > 0 ? 'rgba(34, 197, 94, 1)' :
                                v < 0 ? 'rgba(239, 68, 68, 1)' :
                                    'rgba(156, 163, 175, 1)'
                        ),
                        borderWidth: 1
                    },
                    {
                        label: '전주 대비',
                        data: changesFromLast,
                        backgroundColor: changesFromLast.map(v =>
                            v > 0 ? 'rgba(59, 130, 246, 0.7)' :
                                v < 0 ? 'rgba(251, 146, 60, 0.7)' :
                                    'rgba(156, 163, 175, 0.7)'
                        ),
                        borderColor: changesFromLast.map(v =>
                            v > 0 ? 'rgba(59, 130, 246, 1)' :
                                v < 0 ? 'rgba(251, 146, 60, 1)' :
                                    'rgba(156, 163, 175, 1)'
                        ),
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    datalabels: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        ticks: {
                            callback: function (value) {
                                return (value > 0 ? '+' : '') + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    async function loadMonthlySales() {
        try {
            const response = await fetch(`${API_BASE_URL}/monthly`);

            if (!response.ok) {
                throw new Error('월별 판매 데이터 로드 실패');
            }

            const data = await response.json();

            // 기간 정보 표시
            document.getElementById('monthlyPeriodInfo').textContent =
                `${formatYearMonth(data.startMonth)} ~ ${formatYearMonth(data.endMonth)}`;

            // 차트 렌더링
            renderMonthlyTrendChart(data);

        } catch (error) {
            console.error('월별 판매 데이터 로드 에러:', error);
        }
    }

    function formatYearMonth(yearMonth) {
        const [year, month] = yearMonth.split('-');
        return `${year}년 ${parseInt(month)}월`;
    }

    function renderMonthlyTrendChart(data) {
        const ctx = document.getElementById('monthlyTrendChart');

        // 기존 차트 파괴
        if (monthlyTrendChart) {
            monthlyTrendChart.destroy();
        }

        // 월 레이블 생성 (예: 2024-11 → 11월)
        const labels = data.productSales[0]?.monthlySales.map(m => {
            const [year, month] = m.yearMonth.split('-');
            return `${year}.${month}`;
        }) || [];

        // 제품별 색상 정의
        const colorPalette = [
            { border: 'rgb(99, 102, 241)', background: 'rgba(99, 102, 241, 0.7)' },   // Indigo
            { border: 'rgb(239, 68, 68)', background: 'rgba(239, 68, 68, 0.7)' },     // Red
            { border: 'rgb(34, 197, 94)', background: 'rgba(34, 197, 94, 0.7)' },     // Green
            { border: 'rgb(234, 179, 8)', background: 'rgba(234, 179, 8, 0.7)' },     // Yellow
            { border: 'rgb(168, 85, 247)', background: 'rgba(168, 85, 247, 0.7)' },   // Purple
            { border: 'rgb(236, 72, 153)', background: 'rgba(236, 72, 153, 0.7)' },   // Pink
            { border: 'rgb(20, 184, 166)', background: 'rgba(20, 184, 166, 0.7)' },   // Teal
            { border: 'rgb(249, 115, 22)', background: 'rgba(249, 115, 22, 0.7)' }    // Orange
        ];

        // 데이터셋 생성
        const datasets = data.productSales.map((product, index) => {
            const color = colorPalette[index % colorPalette.length];
            return {
                label: product.displayName,
                data: product.monthlySales.map(m => m.quantity),
                backgroundColor: color.background,
                borderColor: color.border,
                borderWidth: 1
            };
        });

        // 차트 생성 (stacked bar chart)
        monthlyTrendChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12,
                                family: 'notosanskr'
                            },
                            usePointStyle: true,
                            pointStyle: 'rectRounded'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function (context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y.toLocaleString();
                                return `${label}: ${value}개`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true, // X축 누적
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 11,
                                family: 'notosanskr'
                            },
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        stacked: true, // Y축 누적
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 11,
                                family: 'notosanskr'
                            },
                            callback: function (value) {
                                return value.toLocaleString() + '개';
                            }
                        },
                        title: {
                            display: true,
                            text: '판매량',
                            font: {
                                size: 12,
                                weight: 'bold',
                                family: 'notosanskr'
                            }
                        }
                    }
                }
            }
        });
    }

    /**
     * 연간 판매 데이터를 isFeatured와 productLine 기준으로 그룹화
     */
    // function groupYearlySalesData(productMap) {
    //     const productLookup = new Map();
    //     allProducts.forEach(product => {
    //         productLookup.set(product.productCode, product);
    //     });
    //
    //     // 그룹별 데이터 저장
    //     const groups = new Map();
    //     let othersQuantity = 0;
    //     let othersAmountKRW = 0;
    //
    //     // 제품 데이터를 그룹화
    //     productMap.forEach((productData, productCode) => {
    //         const product = productLookup.get(productCode);
    //
    //         if (!product) {
    //             // 제품 정보가 없으면 기타로 분류
    //             othersQuantity += productData.quantity;
    //             othersAmountKRW += productData.totalAmountKRW;
    //             return;
    //         }
    //
    //         if (product.isFeatured) {
    //             // 주요 제품
    //             if (product.productLine) {
    //                 // productLine이 있으면 그룹화
    //                 const groupKey = product.productLine.name;
    //                 if (!groups.has(groupKey)) {
    //                     groups.set(groupKey, {
    //                         name: groupKey,
    //                         isGroup: true,
    //                         quantity: 0,
    //                         totalAmountKRW: 0
    //                     });
    //                 }
    //                 const group = groups.get(groupKey);
    //                 group.quantity += productData.quantity;
    //                 group.totalAmountKRW += productData.totalAmountKRW;
    //             } else {
    //                 // productLine이 없으면 개별 표시
    //                 groups.set(productCode, {
    //                     name: productData.productName,
    //                     code: productCode,
    //                     isGroup: false,
    //                     quantity: productData.quantity,
    //                     totalAmountKRW: productData.totalAmountKRW
    //                 });
    //             }
    //         } else {
    //             // 주요 제품이 아니면 기타로 합산
    //             othersQuantity += productData.quantity;
    //             othersAmountKRW += productData.totalAmountKRW;
    //         }
    //     });
    //
    //     // 주요 제품 중 판매량이 0인 것도 추가
    //     allProducts.forEach(product => {
    //         if (product.isFeatured) {
    //             if (product.productLine) {
    //                 const groupKey = product.productLine.name;
    //                 if (!groups.has(groupKey)) {
    //                     groups.set(groupKey, {
    //                         name: groupKey,
    //                         isGroup: true,
    //                         quantity: 0,
    //                         totalAmountKRW: 0
    //                     });
    //                 }
    //             } else {
    //                 if (!groups.has(product.productCode)) {
    //                     groups.set(product.productCode, {
    //                         name: product.name,
    //                         code: product.productCode,
    //                         isGroup: false,
    //                         quantity: 0,
    //                         totalAmountKRW: 0
    //                     });
    //                 }
    //             }
    //         }
    //     });
    //
    //     // 기타 추가
    //     if (othersQuantity > 0 || groups.size > 0) {
    //         groups.set('__others__', {
    //             name: '기타',
    //             isGroup: true,
    //             quantity: othersQuantity,
    //             totalAmountKRW: othersAmountKRW
    //         });
    //     }
    //
    //     return Array.from(groups.values());
    // }
    /**
     * 연간 판매 데이터를 isFeatured와 productLine 기준으로 그룹화
     */
    function groupYearlySalesData(productMap) {
        // allProducts를 productCode로 빠르게 찾기 위한 Map 생성
        const productLookup = new Map();
        allProducts.forEach(product => {
            productLookup.set(product.productCode, product);
        });

        // 그룹별 데이터 저장
        const groups = new Map();
        let othersQuantity = 0;
        let othersAmountKRW = 0;
        // 기타에 포함된 제품들을 추적
        const othersProducts = [];

        // 제품 데이터를 그룹화
        productMap.forEach((productData, productCode) => {
            const product = productLookup.get(productCode);

            if (!product) {
                // 제품 정보가 없으면 기타로 분류
                othersQuantity += productData.quantity;
                othersAmountKRW += productData.totalAmountKRW;
                // 기타 제품 목록에 추가
                othersProducts.push({
                    name: productData.productName,
                    quantity: productData.quantity
                });
                return;
            }

            if (product.isFeatured) {
                // 주요 제품
                if (product.productLine) {
                    // productLine이 있으면 그룹화
                    const groupKey = product.productLine.name;
                    if (!groups.has(groupKey)) {
                        groups.set(groupKey, {
                            name: groupKey,
                            isGroup: true,
                            quantity: 0,
                            totalAmountKRW: 0
                        });
                    }
                    const group = groups.get(groupKey);
                    group.quantity += productData.quantity;
                    group.totalAmountKRW += productData.totalAmountKRW;
                } else {
                    // productLine이 없으면 개별 표시
                    groups.set(productCode, {
                        name: productData.productName,
                        code: productCode,
                        isGroup: false,
                        quantity: productData.quantity,
                        totalAmountKRW: productData.totalAmountKRW
                    });
                }
            } else {
                // 주요 제품이 아니면 기타로 합산
                othersQuantity += productData.quantity;
                othersAmountKRW += productData.totalAmountKRW;
                // 기타 제품 목록에 추가
                othersProducts.push({
                    name: productData.productName,
                    quantity: productData.quantity
                });
            }
        });

        // 주요 제품 중 판매량이 0인 것도 추가
        allProducts.forEach(product => {
            if (product.isFeatured) {
                if (product.productLine) {
                    const groupKey = product.productLine.name;
                    if (!groups.has(groupKey)) {
                        groups.set(groupKey, {
                            name: groupKey,
                            isGroup: true,
                            quantity: 0,
                            totalAmountKRW: 0
                        });
                    }
                } else {
                    if (!groups.has(product.productCode)) {
                        groups.set(product.productCode, {
                            name: product.name,
                            code: product.productCode,
                            isGroup: false,
                            quantity: 0,
                            totalAmountKRW: 0
                        });
                    }
                }
            }
        });

        // 기타 추가 - 최다 판매 제품명 표시
        if (othersQuantity > 0 || groups.size > 0) {
            let othersName = '기타';

            if (othersProducts.length > 0) {
                // 판매량 기준으로 정렬하여 최다 판매 제품 찾기
                othersProducts.sort((a, b) => b.quantity - a.quantity);
                const topProduct = othersProducts[0];
                const otherCount = othersProducts.length - 1;

                if (otherCount > 0) {
                    othersName = `기타(${topProduct.name} 외 ${otherCount}건)`;
                } else {
                    othersName = topProduct.name;
                }
            }

            groups.set('__others__', {
                name: othersName,
                isGroup: true,
                isOthers: true,
                quantity: othersQuantity,
                totalAmountKRW: othersAmountKRW
            });
        }

        return Array.from(groups.values());
    }

    async function loadYearlySales(year) {
        try {
            const response = await fetch(`${API_BASE_URL}/yearly/${year}`);
            if (!response.ok) throw new Error('연간 판매 데이터 로드 실패');

            const data = await response.json();

            // 금년 제품별 누적 판매량 계산 및 표시
            if (year === new Date().getFullYear()) {
                renderYearlyTotalSales(data.clientSales);
            } else {
                document.getElementById('yearlyTotalTable').querySelector('tbody').innerHTML =
                    '<tr><td colspan="4" class="empty-state">금년 데이터만 표시됩니다</td></tr>';
                document.getElementById('yearlyTotalPeriod').textContent = '';
            }

            renderYearlySales(data.clientSales);
        } catch (error) {
            console.error('Error:', error);
        }
    }

    function renderYearlyTotalSales(clientSales) {
        const tbody = document.getElementById('yearlyTotalTable').querySelector('tbody');
        const productMap = new Map();

        // 모든 거래처의 제품 판매량 집계 (원화 기준)
        clientSales.forEach(client => {
            client.productSales.forEach(product => {
                // 원화 환산 금액 사용 (totalAmountKRW가 없으면 totalAmount 사용)
                const amountKRW = product.totalAmountKRW || product.totalAmount;

                if (productMap.has(product.productCode)) {
                    const existing = productMap.get(product.productCode);
                    existing.quantity += product.quantity;
                    existing.totalAmountKRW += amountKRW;
                } else {
                    productMap.set(product.productCode, {
                        productCode: product.productCode,
                        productName: product.productName,
                        quantity: product.quantity,
                        totalAmountKRW: amountKRW
                    });
                }
            });
        });

        // 그룹화된 제품 데이터 생성
        const groupedProducts = groupYearlySalesData(productMap);

        if (groupedProducts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="empty-state">판매 데이터가 없습니다</td></tr>';
            document.getElementById('yearlyTotalPeriod').textContent = '';
            return;
        }

        // "기타(~ 외 *건)"를 마지막으로 정렬
        const sortedProducts = [...groupedProducts].sort((a, b) => {
            if (a.isOthers) return 1;
            if (b.isOthers) return -1;
            return b.quantity - a.quantity;
        });

        const totalQty = sortedProducts.reduce((sum, p) => sum + p.quantity, 0);
        const totalAmountKRW = sortedProducts.reduce((sum, p) => sum + p.totalAmountKRW, 0);

        document.getElementById('yearlyTotalPeriod').textContent =
            `${new Date().getFullYear()}년 1월 1일 ~ 현재`;

        tbody.innerHTML = sortedProducts
            .filter(product => product.totalAmountKRW !== 0) // ✅ 0이 아닌 항목만 표시
            .map(product => `
                <tr>
                    <td><strong>${product.name}</strong></td>
                    <td>${product.code || '-'}</td>
                    <td>${product.quantity.toLocaleString()}</td>
                    <td class="price-text">${formatPrice(product.totalAmountKRW)}</td>
                </tr>
            `).join('') + `
                <tr style="background: #f3f4f6; font-weight: 700;">
                    <td colspan="2">총계</td>
                    <td>${totalQty.toLocaleString()}</td>
                    <td class="price-text">${formatPrice(totalAmountKRW)}</td>
                </tr>
            `;


        // 차트 렌더링
        renderYearlyCharts(sortedProducts);
    }

    // renderYearlyCharts 함수 수정
    function renderYearlyCharts(products) {

        // 색상 팔레트
        const colors = [
            '#5470C6', '#91CC75', '#EE6666', '#FAC858', '#73C0DE',
            '#3BA272', '#FC8452', '#9A60B4', '#EA7CCC', '#2ec7c9'
        ];

        const productNames = products.map(p => p.name);
        const quantities = products.map(p => p.quantity);
        const totalAmounts = products.map(p => p.totalAmountKRW);

        const pieDom = document.getElementById('yearlyPieChart');
        const pieChart = echarts.init(pieDom);
        const pieOption = {
            grid: {
                top: 10,
                bottom: 10,
                left: 10,
                right: 10,
                containLabel: false
            },
            tooltip: {
                trigger: 'item',
                formatter: '{b}<br/>판매량: {c}개 ({d}%)'
            },
            series: [{
                name: '판매량',
                type: 'pie',
                radius: ['35%', '80%'], // 도넛 형태
                center: ['50%', '50%'],
                avoidLabelOverlap: true,
                label: {
                    show: true,
                    position: 'outside',
                    formatter: '{b} ({d}%)',
                    fontSize: 15
                },
                labelLine: {
                    show: true,
                    length: 20,
                    length2: 15,
                    smooth: true
                },
                data: products.map((p, i) => ({
                    name: p.name,
                    value: p.quantity,
                    itemStyle: { color: colors[i % colors.length] }
                }))
            }]
        };
        pieChart.setOption(pieOption);
        window.yearlyPieChart = pieChart;

        const barDom = document.getElementById('yearlyBarChart');
        const barChart = echarts.init(barDom);
        const barOption = {
            grid: {
                top: 20,
                bottom: 60,
                left: 60,
                right: 20,
                containLabel: false
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: { type: 'shadow' },
                formatter: function(params) {
                    const v = params[0].value.toLocaleString();
                    return `${params[0].axisValue}<br/>판매액: ₩${v}`;
                }
            },
            xAxis: {
                type: 'category',
                data: productNames,
                axisLabel: {
                    rotate: 30,
                    formatter: function(name) {
                        return name.length > 8 ? name.substring(0, 7) + '…' : name;
                    }
                }
            },
            yAxis: {
                type: 'value',
                axisLabel: {
                    formatter: function(v) {
                        return '₩' + (v / 1_000_000).toFixed(0) + 'M';
                    }
                }
            },
            series: [{
                name: '판매액',
                type: 'bar',
                data: totalAmounts,
                itemStyle: {
                    color: function(params) {
                        return colors[params.dataIndex % colors.length];
                    },
                    borderRadius: [6, 6, 0, 0]
                }
            }]
        };
        barChart.setOption(barOption);
        window.yearlyBarChart = barChart;
    }


    function renderYearlySales(clientSales) {
        const container = document.getElementById('yearlyStats');

        if (clientSales.length === 0) {
            container.innerHTML = '<div class="empty-state">판매 데이터가 없습니다</div>';
            return;
        }

        // 상위 거래처 ID를 키로 하는 맵 생성
        const parentClientMap = new Map();

        // 1단계: 모든 거래처를 순회하며 상위 거래처별로 그룹화
        clientSales.forEach(client => {
            const parentId = client.parentClientId || client.clientId;

            if (!parentClientMap.has(parentId)) {
                // ===== allClients에서 상위 거래처 정보 찾기 =====
                const parentClientInfo = allClients.find(c => c.id === parentId);

                // 판매 데이터에서 상위 거래처 찾기 (있을 수도 있음)
                const parentSalesData = clientSales.find(c => c.clientId === parentId);

                // 우선순위: 1) allClients의 정보, 2) 판매 데이터의 정보, 3) 현재 client 정보
                const parentData = parentClientInfo || parentSalesData || client;

                parentClientMap.set(parentId, {
                    clientId: parentId,
                    clientCode: parentData.clientCode || client.clientCode,
                    clientName: parentData.name || parentData.clientName || client.clientName,
                    countryName: parentData.countryName || (parentData.country?.name) || client.countryName,
                    currency: parentData.currency || client.currency,
                    productSalesMap: new Map(),
                    totalAmount: 0,
                    totalAmountKRW: 0,
                    childNames: [],
                    childClients: [],
                    parentSalesData: parentSalesData  // 상위 거래처 판매 데이터 저장
                });
            }

            const parentGroup = parentClientMap.get(parentId);

            // 상위 거래처 자신이 아닌 하위 거래처만 childClients에 추가
            if (client.clientId !== parentId) {
                parentGroup.childNames.push(client.clientName);
                parentGroup.childClients.push(client);
            }

            // 제품별 판매량 집계 (상위 + 하위 모두 포함)
            client.productSales.forEach(product => {
                const key = product.productCode;

                if (!parentGroup.productSalesMap.has(key)) {
                    parentGroup.productSalesMap.set(key, {
                        productCode: product.productCode,
                        productName: product.productName,
                        quantity: 0,
                        totalAmount: 0,
                        totalAmountKRW: 0
                    });
                }

                const aggregated = parentGroup.productSalesMap.get(key);
                aggregated.quantity += product.quantity;
                aggregated.totalAmount += Number(product.totalAmount || 0);
                aggregated.totalAmountKRW += Number(product.totalAmountKRW || 0);
            });

            parentGroup.totalAmount += Number(client.totalAmount || 0);
            parentGroup.totalAmountKRW += Number(client.totalAmountKRW || 0);
        });

        // 2단계: 통합된 데이터로 배열 생성
        const mergedClients = Array.from(parentClientMap.values()).map(group => ({
            clientId: group.clientId,
            clientCode: group.clientCode,
            clientName: group.clientName,
            countryName: group.countryName,
            currency: group.currency,
            productSales: Array.from(group.productSalesMap.values())
                .sort((a, b) => b.quantity - a.quantity),
            totalAmount: group.totalAmount,
            totalAmountKRW: group.totalAmountKRW,
            childNames: group.childNames,
            childClients: group.childClients,
            parentSalesData: group.parentSalesData  // 모달에서 사용
        }));

        mergedClients.sort((a, b) => b.totalAmountKRW - a.totalAmountKRW);

        // 3단계: HTML 렌더링
        container.innerHTML = mergedClients.map((client, index) => {
            const currencyInfo = client.currency && client.currency !== 'KRW'
                ? `<span class="client-country">${client.currency}</span>`
                : '';

            const krwAmount = client.totalAmountKRW && client.currency !== 'KRW'
                ? `<div style="font-size: 0.875rem; color: #6b7280; margin-top: 4px;">(₩${formatNumber(client.totalAmountKRW)})</div>`
                : '';

            const clientLabel = client.childNames.length > 0
                ? `${client.clientName}
<!--                    <span style="font-size: 0.8rem; color: #9ca3af;">(포함: ${client.childNames.join(', ')})</span>-->`
                : client.clientName;

            // 상세보기 버튼: 상위 거래처에 판매 데이터가 있거나 하위 거래처가 있을 때 표시
            const hasDetails = client.parentSalesData || client.childClients.length > 0;
            const detailButton = hasDetails
                ? `<button class="btn-detail" onclick="openChildClientsModal(${index})">
                상세보기
               </button>`
                : '';

            return `
            <div class="client-section" data-client-index="${index}">
                <div class="client-header">
                    <div class="client-info">
                        <span class="client-name">${clientLabel}</span>
                        <span class="client-country">${client.countryName}</span>
                        ${currencyInfo}
                    </div>
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="text-align: right;">
                            <span class="client-total">${formatPrice(client.totalAmountKRW)}</span>
                            ${client.currency !== 'KRW' ? `<div style="font-size: 0.875rem; color: #6b7280; margin-top: 4px;">(${formatPriceByCurrency(client.totalAmount, client.currency)})</div>` : ''}
                        </div>
                        ${detailButton}
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                        <tr>
                            <th>제품코드</th>
                            <th>제품명</th>
                            <th>판매량</th>
                            <th>판매액</th>
                        </tr>
                        </thead>
                        <tbody>
                            ${client.productSales.map(product => {
                                const productKrwDisplay = client.currency === 'KRW'
                                    ? formatPrice(product.totalAmountKRW)
                                    : `${formatPriceByCurrency(product.totalAmount, client.currency)}<div style="font-size: 0.75rem; color: #6b7280; margin-top: 2px;">(₩${formatNumber(product.totalAmountKRW)})</div>`;
                                return `
                                        <tr>
                                            <td><strong>${product.productCode}</strong></td>
                                            <td>${product.productName}</td>
                                            <td>${product.quantity.toLocaleString()}</td>
                                            <td class="price-text">${productKrwDisplay}</td>
                                        </tr>
                                    `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        }).join('');

        window.currentMergedClients = mergedClients;
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return `${date.getMonth() + 1}/${date.getDate()}`;
    }

    function formatPriceByCurrency(price, currency) {
        if (!currency || currency === 'KRW') {
            return formatPrice(price);
        }

        const localeMap = {
            'USD': 'en-US',
            'JPY': 'ja-JP',
            'EUR': 'de-DE',
            'CNY': 'zh-CN',
            'GBP': 'en-GB'
        };

        const locale = localeMap[currency] || 'ko-KR';

        return new Intl.NumberFormat(locale, {
            style: 'currency',
            currency: currency
        }).format(price);
    }

    function formatNumber(num) {
        if (!num) return '0';
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function formatPrice(price) {
        return new Intl.NumberFormat('ko-KR', {
            style: 'currency',
            currency: 'KRW'
        }).format(price);
    }

    function openChildClientsModal(clientIndex) {
        const client = window.currentMergedClients[clientIndex];

        // 표시할 데이터가 없으면 리턴
        if (!client || (!client.parentSalesData && (!client.childClients || client.childClients.length === 0))) {
            return;
        }

        document.getElementById('modalParentName').textContent =
            `${client.clientName} - 거래처별 상세`;

        const modalBody = document.getElementById('modalChildClientsBody');

        let html = '';

        // 상위 거래처 본사 데이터가 있으면 먼저 표시
        if (client.parentSalesData) {
            const parent = client.parentSalesData;
            const currencyInfo = parent.currency && parent.currency !== 'KRW'
                ? `<span class="client-country">${parent.currency}</span>`
                : '';

            const krwAmount = parent.totalAmountKRW && parent.currency !== 'KRW'
                ? `<div style="font-size: 0.875rem; color: #6b7280; margin-top: 4px;">(₩${formatNumber(parent.totalAmountKRW)})</div>`
                : '';

            html += `
            <div class="child-client-card" style="border: 2px solid #667eea; background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);">
                <div class="child-client-header">
                    <div class="child-client-name">
                        ${parent.clientName} <span style="font-size: 0.8rem; color: #667eea; font-weight: 700;">(본사)</span>
                        <span class="client-country">${parent.countryName}</span>
                        ${currencyInfo}
                    </div>
                    <div style="text-align: right;">
                        <div class="child-client-total">${formatPriceByCurrency(parent.totalAmount, parent.currency)}</div>
                        ${krwAmount}
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                        <tr>
                            <th>제품코드</th>
                            <th>제품명</th>
                            <th>판매량</th>
                            <th>판매액</th>
                        </tr>
                        </thead>
                        <tbody>
                            ${parent.productSales.map(product => `
                                <tr>
                                    <td><strong>${product.productCode}</strong></td>
                                    <td>${product.productName}</td>
                                    <td>${product.quantity.toLocaleString()}</td>
                                    <td class="price-text">${formatPriceByCurrency(product.totalAmount, parent.currency)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        }

        // 하위 거래처 데이터 표시
        if (client.childClients && client.childClients.length > 0) {
            html += client.childClients.map(child => {
                const currencyInfo = child.currency && child.currency !== 'KRW'
                    ? `<span class="client-country">${child.currency}</span>`
                    : '';

                const krwAmount = child.totalAmountKRW && child.currency !== 'KRW'
                    ? `<div style="font-size: 0.875rem; color: #6b7280; margin-top: 4px;">(₩${formatNumber(child.totalAmountKRW)})</div>`
                    : '';

                return `
                <div class="child-client-card">
                    <div class="child-client-header">
                        <div class="child-client-name">
                            ${child.clientName}
                            <span class="client-country">${child.countryName}</span>
                            ${currencyInfo}
                        </div>
                        <div style="text-align: right;">
                            <div class="child-client-total">${formatPriceByCurrency(child.totalAmount, child.currency)}</div>
                            ${krwAmount}
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                            <tr>
                                <th>제품코드</th>
                                <th>제품명</th>
                                <th>판매량</th>
                                <th>판매액</th>
                            </tr>
                            </thead>
                            <tbody>
                                ${child.productSales.map(product => `
                                    <tr>
                                        <td><strong>${product.productCode}</strong></td>
                                        <td>${product.productName}</td>
                                        <td>${product.quantity.toLocaleString()}</td>
                                        <td class="price-text">${formatPriceByCurrency(product.totalAmount, child.currency)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            }).join('');
        }

        modalBody.innerHTML = html;
        document.getElementById('childClientsModal').style.display = 'block';
    }

    function closeChildClientsModal() {
        document.getElementById('childClientsModal').style.display = 'none';
    }

    // 모달 외부 클릭 시 닫기
    window.onclick = function(event) {
        const childModal = document.getElementById('childClientsModal');
        const productModal = document.getElementById('productListModal');

        if (event.target === childModal) {
            closeChildClientsModal();
        }

        if (event.target === productModal) {
            closeProductListModal();
        }
    }

    // ESC 키로 모달 닫기
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' || event.key === 'Esc') {
            const childModal = document.getElementById('childClientsModal');
            const productModal = document.getElementById('productListModal');

            if (childModal.style.display === 'block') {
                closeChildClientsModal();
            }

            if (productModal.style.display === 'block') {
                closeProductListModal();
            }
        }
    });

    // 제품 목록 모달 열기
    async function openProductListModal() {
        const modal = document.getElementById('productListModal');
        modal.style.display = 'block';

        await loadProducts();

        renderProductListModal();
    }

    // 제품 목록 모달 닫기
    function closeProductListModal() {
        const modal = document.getElementById('productListModal');
        modal.style.display = 'none';
        setTimeout(() => {
            location.reload();
        }, 100);
    }

    // 제품 목록 모달 렌더링
    function renderProductListModal() {
        const modalBody = document.getElementById('productListModalBody');

        if (!allProducts || allProducts.length === 0) {
            modalBody.innerHTML = `
                <div style="text-align: center; color: #6b7280; padding: 40px;">
                    등록된 제품이 없습니다.
                </div>
            `;
            return;
        }

        // productLine이 있는 제품을 상단에, 없는 제품을 하단에 배치
        const sortedProducts = [...allProducts].sort((a, b) => {
            // productLine이 있는 것을 우선
            if (a.productLine && !b.productLine) return -1;
            if (!a.productLine && b.productLine) return 1;

            // productLine이 같으면 제품명순
            if (a.productLine && b.productLine) {
                const lineCompare = a.productLine.name.localeCompare(b.productLine.name, 'ko');
                if (lineCompare !== 0) return lineCompare;
            }

            return a.name.localeCompare(b.name, 'ko');
        });

        // productLine별로 그룹화하여 rowspan 계산
        const productLineGroups = new Map();
        sortedProducts.forEach(product => {
            const lineName = product.productLine ? product.productLine.name : null;
            if (!productLineGroups.has(lineName)) {
                productLineGroups.set(lineName, []);
            }
            productLineGroups.get(lineName).push(product);
        });

        let tableRows = '';
        let isFirstInGroup = true;
        let currentProductLine = null;

        sortedProducts.forEach((product, index) => {
            const lineName = product.productLine ? product.productLine.name : null;

            // 새로운 productLine 그룹의 시작인지 확인
            if (currentProductLine !== lineName) {
                isFirstInGroup = true;
                currentProductLine = lineName;
            }

            const rowspan = isFirstInGroup ? productLineGroups.get(lineName).length : 0;

            tableRows += '<tr>';

            // productLine 컬럼 (병합)
            if (isFirstInGroup) {
                const lineDisplay = lineName
                    ? lineName
                    : '<span class="no-product-line">-</span>';
                tableRows += `<td rowspan="${rowspan}">${lineDisplay}</td>`;
            }

            // 제품명(제품코드) 컬럼
            tableRows += `
                <td class="product-name-cell">
                    <span class="product-name-text">${product.name}</span>
                </td>
            `;

            // 주요 제품 체크박스 컬럼
            tableRows += `
                <td>
                    <div class="featured-cell">
                        <input type="checkbox" class="featured-checkbox-input"
                               data-product-id="${product.id}"
                               ${product.isFeatured ? 'checked' : ''}
                               onchange="toggleProductFeatured(${product.id})">
                    </div>
                </td>
            `;

            tableRows += '</tr>';

            isFirstInGroup = false;
        });

        modalBody.innerHTML = `
            <table class="product-list-table">
                <thead>
                    <tr>
                        <th>제품라인</th>
                        <th>제품명</th>
                        <th>주요 제품</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        `;
    }

    // 주요 제품 토글
    async function toggleProductFeatured(productId) {
        try {
            const response = await fetch(`${PRODUCTS_API_URL}/${productId}/toggle-featured`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error('주요 제품 설정 변경에 실패했습니다');
            }

            const updatedProduct = await response.json();

            // allProducts 배열에서 해당 제품 업데이트
            const productIndex = allProducts.findIndex(p => p.id === productId);
            if (productIndex !== -1) {
                allProducts[productIndex] = updatedProduct;
            }

            // 모달 다시 렌더링
            renderProductListModal();

        } catch (error) {
            console.error('Error:', error);
            alert('주요 제품 설정 변경에 실패했습니다');

            // 에러 발생 시 체크박스 상태 원복을 위해 다시 로드
            await loadProducts();
            renderProductListModal();
        }
    }
</script>
</body>
</html>