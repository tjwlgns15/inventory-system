<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>ì™„ì œí’ˆ ê´€ë¦¬</title>
    <style>
      @import url('//fonts.googleapis.com/earlyaccess/notosanskr.css');
      
      body {
        font-family: 'notosanskr', sans-serif;
        background: #ffffff;
        padding: 40px;
        color: #333;
        margin: 0;
      }
      
      h1 {
        text-align: center;
        font-size: 28px;
        margin-bottom: 20px;
      }
      
      .modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.45);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      
      .modal-content {
        background: white;
        padding: 24px;
        border-radius: 10px;
        width: 90%;
        max-width: 800px;
        height: auto;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      }
      
      button {
        padding: 8px 14px;
        margin: 4px;
        background-color: #007bff;
        border: none;
        border-radius: 6px;
        color: white;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      
      button:hover {
        background-color: #0056b3;
      }
      
      table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        border-radius: 6px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        margin-top: 10px;
      }
      
      th, td {
        padding: 12px 14px;
        text-align: left;
        font-size: 14px;
        border: 1px solid #e5e5e5;
      }
      
      th {
        background: #f1f3f5;
        font-weight: 600;
      }
      
      
      .modal-content h2 {
        margin-top: 0;
        font-size: 22px;
        margin-bottom: 10px;
      }
      
      .modal-actions {
        text-align: right;
        margin-top: 20px;
      }
      .modal-content input[type="text"] {
        width: 100%;
        padding: 8px 10px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        margin-top: 6px;
      }
      
      
      .dual-list {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        margin-top: 16px;
      }
      
      .list-box {
        flex: 1;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 10px;
        background: #fafafa;
        max-height: none;
        height: 520px; /* ì›í•˜ëŠ” ë§Œí¼ ë†’ì´ ì„¤ì • */
        overflow-y: auto;
      }
      
      .list-box h3 {
        font-size: 16px;
        margin-top: 0;
        text-align: center;
      }
      #availableParts,
      #selectedParts {
        max-height: none;
        overflow-y: auto;
        padding-right: 4px; /* ìŠ¤í¬ë¡¤ë°” ê³µê°„ í™•ë³´ */
      }
      
      .part-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
        padding: 6px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #fff;
        font-size: 14px;
      }
      
      .part-item input {
        width: 50px;
        margin-left: auto;
        text-align: right;
      }
      
      .part-item button {
        padding: 4px 8px;
        font-size: 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      
      .part-item button:hover {
        background-color: #0056b3;
      }
      
      .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 12px;
      }
      
      .form-group {
        display: flex;
        flex-direction: column;
      }
      
      label {
        font-weight: bold;
        margin-bottom: 4px;
      }
      
      input {
        padding: 6px 10px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      
      .form-group input {
        flex: 1;
        min-width: 0;
      }
      .action-btn {
        background: #f1f3f5;
        cursor: pointer;
      }
      
      .action-btn:hover {
        background: #e0e0e0;
      }
      
      .action-cell {
      }
      #allHistoryModal .filter-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
      }
      
      #allHistoryModal .filter-bar input {
        padding: 8px;
        font-size: 14px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      
      #allHistoryModal .history-scroll-area {
        flex: 1;
        overflow-y: auto;
        max-height: 60vh;
      }
      #productHistoryModal .history-scroll-area {
        flex: 1;
        overflow-y: auto;
        max-height: 60vh; /* ë†’ì´ ì œí•œ */
        margin-bottom: 10px;
      }
    
    </style>
  </head>
  <body>
  <h1>ì™„ì œí’ˆ ê´€ë¦¬</h1>
  <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
    <div>
      <button onclick="openAllHistoryModal()">ì „ì²´ ì…ì¶œê³  ì´ë ¥ ë³´ê¸°</button>
    </div>
    <div>
      <button onclick="openModal()">ì œí’ˆ ë“±ë¡</button>
    </div>
  </div>
  <div style="text-align: right; margin-bottom: 10px;">
    <input type="text" id="productSearchInput" placeholder="ì œí’ˆëª… ê²€ìƒ‰" oninput="renderProductTable()" style="padding:6px 10px; font-size:14px; border:1px solid #ccc; border-radius:6px; width: 200px;" />
  </div>
  
  
  
  <div class="modal" id="productModal">
    <div class="modal-content">
      <h2>ì œí’ˆ ë“±ë¡</h2>
      <div class="form-row">
        <div class="form-group">
          <label>ì œí’ˆëª…</label>
          <input type="text" id="productName" placeholder="ì œí’ˆëª… ì…ë ¥" />
        </div>
        
        <div class="form-group">
          <label>ì¬ê³ </label>
          <input type="text" id="productStock" placeholder="ì¬ê³  ì…ë ¥" />
        </div>
      </div>
      
      <!-- ë‘ ë²ˆì§¸ ì¤„: ë¶€í’ˆ ê²€ìƒ‰ -->
      <div class="form-group">
        <label>ë¶€í’ˆ ê²€ìƒ‰</label>
        <input type="text" id="partSearchInput" placeholder="ë¶€í’ˆëª… ê²€ìƒ‰" oninput="renderParts()" />
      </div>
      
      <div class="dual-list">
        <div class="list-box">
          <h3>ì „ì²´ ë¶€í’ˆ</h3>
          <div id="availableParts"></div>
        </div>
        <div class="list-box">
          <h3>ì œí’ˆ êµ¬ì„± ë¶€í’ˆ</h3>
          <div id="selectedParts"></div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button onclick="registerProduct()">ë“±ë¡</button>
        <button onclick="closeModal()">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>
  
  <!-- ì „ì²´ ì…ì¶œê³  ì´ë ¥ ëª¨ë‹¬ -->
  <div class="modal" id="allHistoryModal">
    <div class="modal-content">
      <h2>ì „ì²´ ì…ì¶œê³  ì´ë ¥</h2>
      
      <!-- ê²€ìƒ‰/ë‹¬ë ¥ í•„í„° -->
      <div class="filter-bar">
        <input type="text" id="allHistorySearchInput" placeholder="ë¶€í’ˆëª… ë˜ëŠ” ì½”ë“œ ê²€ìƒ‰" oninput="filterAllHistory()" />
        <input type="month" id="allHistoryMonthInput" onchange="filterAllHistory()" />
      </div>
      
      <!-- ìŠ¤í¬ë¡¤ ì˜ì—­ -->
      <div class="history-scroll-area">
        <table id="allHistoryTable">
          <thead>
          <tr>
            <th>ë¶€í’ˆ</th>
            <th>íƒ€ì…</th>
            <th>ì…/ì¶œê³ </th>
            <th>ë³€ê²½ì „</th>
            <th>ë³€ê²½í›„</th>
            <th>ì‹œê°„</th>
          </tr>
          </thead>
          <tbody id="allHistoryTableBody"></tbody> <!-- âœ… ì¶”ê°€ -->
        </table>
      </div>
      
      <div class="modal-actions">
        <button onclick="closeAllHistoryModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
  
  <!-- ë‹¨ì¼ ì œí’ˆ ì´ë ¥ ëª¨ë‹¬ -->
  <div class="modal" id="productHistoryModal">
    <div class="modal-content">
      <h2>ì¬ê³  ë³€ê²½ íˆìŠ¤í† ë¦¬</h2>
      
      <!-- ğŸ”½ ìŠ¤í¬ë¡¤ ì˜ì—­ìœ¼ë¡œ í…Œì´ë¸” ê°ì‹¸ê¸° -->
      <div class="history-scroll-area">
        <table>
          <thead>
          <tr>
            <th>ìœ í˜•</th>
            <th>ë³€ê²½ ì „</th>
            <th>ë³€ë™</th>
            <th>ë³€ê²½ í›„</th>
            <th>ì‹œê°„</th>
          </tr>
          </thead>
          <tbody id="productHistoryTableBody"></tbody>
        </table>
      </div>
      
      <div class="modal-actions">
        <button onclick="closeProductHistoryModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
  
  
  <!--Product List-->
  <table>
    <thead>
    <tr>
      <th>ì œí’ˆëª…</th>
      <th>êµ¬ì„± ë¶€í’ˆ</th>
      <th>ì¬ê³ </th>
      <th>ìƒì‚°</th>
      <th>ì¶œê³ </th>
      <th>ê´€ë¦¬</th>
    </tr>
    </thead>
    <tbody id="productTableBody"></tbody>
  </table>
  
  <div id="sidebar-container"></div>
  <script>
    fetch("/sidebar.html")
            .then(res => res.text())
            .then(html => {
              document.getElementById("sidebar-container").innerHTML = html;
              
              const sidebar = document.getElementById("sidebar");
              const toggleBtn = document.getElementById("menuToggle");
              toggleBtn.addEventListener("click", () => {
                sidebar.classList.toggle("open");
              });
            });
  </script>
  <script>
    let parts = [];
    let products = [];
    const selectedParts = new Map();
    let isEditMode = false;
    let editingProductId = null;
    
    window.onload = () => {
      fetchParts();
      fetchProducts();
    };
    
    function fetchParts() {
      fetch("/api/parts")
              .then((res) => res.json())
              .then((data) => {
                parts = data.map(p => ({ id: p.id, code: p.code, name: p.name }));
                renderParts();
              });
    }
    
    function fetchProducts() {
      fetch("/api/products")
              .then((res) => res.json())
              .then((data) => {
                products = data;
                renderProductTable();
              });
    }

    function openModal(product = null) {
      const modal = document.getElementById("productModal");
      modal.style.display = "flex";

      if(product){
        isEditMode = true;
        editingProductId = product.id;
        document.getElementById("productName").value = product.name;
        document.getElementById("productStock").value = product.stock ?? 0;

        selectedParts.clear();
        product.parts.forEach((partInfo) => {
          const match = parts.find(part => part.code === partInfo.code);
          if(match) {
            selectedParts.set(match.id, partInfo.count);
          }
        });
      } else {
        isEditMode = false;getAllProducts
        editingProductId = null;
        document.getElementById("productName").value = "";
        document.getElementById("productStock").value = "";
        selectedParts.clear();
      }
      renderParts();
    }
    
    function closeModal() {
      document.getElementById("productModal").style.display = "none";
      selectedParts.clear();
      document.getElementById("productName").value = "";
      document.getElementById("productStock").value = "";
      isEditMode = false;
      editingProductId = null;
      renderParts();
    }
    
    function renderParts() {
      const available = document.getElementById("availableParts");
      const selected = document.getElementById("selectedParts");
      const keyword = document.getElementById("partSearchInput")?.value?.toLowerCase() || "";
      available.innerHTML = "";
      selected.innerHTML = "";
      
      parts.forEach((part) => {
        const name = part.name.toLowerCase();
        if (keyword && !name.includes(keyword)) return;
        
        const row = document.createElement("div");
        row.className = "part-item";
        row.innerHTML = `<span>${part.name}</span>`;
        
        if (selectedParts.has(part.id)) {
          const count = selectedParts.get(part.id) || 1;
          row.innerHTML += `
        <input type="number" min="1" value="${count}" onchange="updatePartCount(${part.id}, this.value)" />
        <button onclick="removeFromProduct(${part.id})">ì œê±°</button>`;
          selected.appendChild(row);
        } else {
          row.innerHTML += `<button onclick="addToProduct(${part.id})">ì¶”ê°€</button>`;
          available.appendChild(row);
        }
      });
    }
    
    function addToProduct(partId) {
      selectedParts.set(partId, 1);
      renderParts();
    }
    
    function removeFromProduct(partId) {
      selectedParts.delete(partId);
      renderParts();
    }
    
    function updatePartCount(partId, value) {
      const intVal = parseInt(value);
      if (intVal > 0) {
        selectedParts.set(partId, intVal);
      }
    }
    
    function registerProduct() {
      const name = document.getElementById("productName").value.trim();
      const stock = document.getElementById("productStock").value.trim();
      if (!name || selectedParts.size === 0) {
        alert("ì œí’ˆëª…ê³¼ ë¶€í’ˆì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }
      
      const partData = Array.from(selectedParts.entries()).map(([id, count]) => {
        const part = parts.find(p => p.id === id);
        return { code: part.code, count: count };
      });
      
      const payload = { name: name, parts: partData, stock:isNaN(stock) ? 0 : stock };
      
      const method = isEditMode ? "PATCH" : "POST";
      const url = isEditMode ? `/api/products/product/${editingProductId}` : "/api/products";
      
      fetch(url, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      })
              .then((res) => {
                if (res.ok) {
                  alert(isEditMode ? "ìˆ˜ì • ì™„ë£Œ" : "ë“±ë¡ ì™„ë£Œ");
                  closeModal();
                  fetchProducts();
                } else {
                  res.text().then((msg) => alert("ì‹¤íŒ¨: " + msg));
                }
              });
    }
    
    function renderProductTable() {
      const tbody = document.getElementById("productTableBody");
      const keyword = document.getElementById("productSearchInput")?.value?.toLowerCase() || "";
      tbody.innerHTML = "";
      
      products
              .filter(p => p.name.toLowerCase().includes(keyword)) // â† í•„í„°ë§ ì¶”ê°€
              .forEach((p) => {
                const partsText = p.parts.map(pp => `${pp.name}`).join(", ");
                const row = document.createElement("tr");
                row.innerHTML = `
        <td>${p.name}</td>
        <td>${partsText}</td>
        <td>${p.stock}</td>
        <td>
          <input type="number" id="produceInput-${p.id}" value="1" style="width: 60px;" />
          <button onclick="produceProduct(${p.id})">ìƒì‚°</button>
        </td>
        <td>
          <input type="number" id="dispatchInput-${p.id}" value="1" style="width: 60px;" />
          <button onclick="dispatchProduct(${p.id})">ì¶œê³ </button>
        </td>
        <td class="action-cell">
          <button class="action-btn" onclick="openProductHistoryModal(${p.id})">ğŸ“œ</button>
          <button class="action-btn" onclick="editProduct(event, ${p.id})">âœï¸</button>
          <button class="action-btn" onclick="deleteProduct(event, ${p.id})">ğŸ—‘ï¸</button>
        </td>
      `;
                tbody.appendChild(row);
              });
    }
    
    
    function editProduct(event, id) {
      event.stopPropagation(); // tr í´ë¦­ ì´ë²¤íŠ¸ ì°¨ë‹¨
      const product = products.find(p => p.id === id);
      openModal(product);
    }
    
    function produceProduct(productId) {
      const input = document.getElementById(`produceInput-${productId}`);
      const delta = parseInt(input.value);
      
      if (isNaN(delta) || delta <= 0) {
        alert("ìƒì‚° ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      
      fetch("/api/products/produce", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productId: productId, delta: delta })
      })
              .then(res => {
                if (res.ok) {
                  alert("ìƒì‚° ì™„ë£Œ");
                  fetchProducts();
                } else {
                  return res.text().then(msg => { throw new Error(msg); });
                }
              })
              .catch(err => alert("ìƒì‚° ì‹¤íŒ¨: " + err.message));
    }
    
    function deleteProduct(event, productId) {
      event.stopPropagation(); // í–‰(row)ì˜ í´ë¦­ ì´ë²¤íŠ¸ ì°¨ë‹¨
      
      if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      
      fetch(`/api/products/${productId}`, {
        method: "DELETE"
      })
              .then(res => {
                if (res.ok) {
                  alert("ì‚­ì œ ì™„ë£Œ");
                  fetchProducts(); // ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
                } else {
                  return res.text().then(msg => { throw new Error(msg); });
                }
              })
              .catch(err => alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message));
    }
    
    let allHistoryRaw = []; // ì „ì²´ ë°ì´í„° ì €ì¥ìš©
    
    function openAllHistoryModal() {
      fetch("/api/products/history/all")
              .then(res => res.json())
              .then(data => {
                allHistoryRaw = data;
                
                // ğŸ—“ ì´ˆê¸° ë‹¬ë ¥ì€ ì˜¤ëŠ˜ ê¸°ì¤€
                const monthInput = document.getElementById("allHistoryMonthInput");
                const today = new Date();
                const yyyyMm = today.toISOString().slice(0, 7);
                monthInput.value = yyyyMm;
                
                renderAllHistory(allHistoryRaw);
                document.getElementById("allHistoryModal").style.display = "flex";
              })
              .catch(err => alert("ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨: " + err.message));
    }
    
    function filterAllHistory() {
      const keyword = document.getElementById("allHistorySearchInput").value.toLowerCase();
      const selectedMonth = document.getElementById("allHistoryMonthInput").value; // 'YYYY-MM'
      
      const filtered = allHistoryRaw.filter(tx => {
        const nameMatch = tx.productName?.toLowerCase().includes(keyword);
        const monthMatch = selectedMonth === "" || tx.createdAt?.startsWith(selectedMonth);
        return nameMatch && monthMatch;
      });
      
      renderAllHistory(filtered);
    }
    
    function renderAllHistory(data) {
      const tbody = document.getElementById("allHistoryTableBody");
      tbody.innerHTML = "";
      data.forEach(tx => {
        const row = document.createElement("tr");
        row.innerHTML = `
      <td>${tx.productName}</td>
      <td>${tx.type}</td>
      <td>${tx.beforeStock}</td>
      <td>${tx.delta}</td>
      <td>${tx.afterStock}</td>
      <td>${new Date(tx.createdAt).toLocaleString()}</td>
    `;
        tbody.appendChild(row);
      });
    }
    
    
    
    function closeAllHistoryModal() {
      document.getElementById("allHistoryModal").style.display = "none";
    }
    
    
    function openProductHistoryModal(productId) {
      fetch(`/api/products/product/${productId}/history`)
              .then(res => res.json())
              .then(data => {
                const tbody = document.getElementById("productHistoryTableBody");
                tbody.innerHTML = "";
                data.forEach(tx => {
                  const row = document.createElement("tr");
                  row.innerHTML = `
          <td>${tx.type}</td>
          <td>${tx.beforeStock}</td>
          <td>${tx.delta}</td>
          <td>${tx.afterStock}</td>
          <td>${new Date(tx.createdAt).toLocaleString()}</td>
        `;
                  tbody.appendChild(row);
                });
                document.getElementById("productHistoryModal").style.display = "flex";
              });
    }
    
    function closeProductHistoryModal() {
      document.getElementById("productHistoryModal").style.display = "none";
    }
    
    function dispatchProduct(productId) {
      const input = document.getElementById(`dispatchInput-${productId}`);
      const delta = parseInt(input.value);
      
      if (isNaN(delta) || delta <= 0) {
        alert("ì¶œê³  ìˆ˜ëŸ‰ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      
      fetch("/api/products/dispatch", {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productId: productId, delta: delta })
      })
              .then(res => {
                if (res.ok) {
                  alert("ì¶œê³  ì™„ë£Œ");
                  fetchProducts(); // ì¬ê³  ê°±ì‹ 
                } else {
                  return res.text().then(msg => { throw new Error(msg); });
                }
              })
              .catch(err => alert("ì¶œê³  ì‹¤íŒ¨: " + err.message));
    }
    document.addEventListener("DOMContentLoaded", () => {
      const monthInput = document.getElementById("allHistoryMonthInput");
      const today = new Date();
      monthInput.value = today.toISOString().slice(0, 7); // í˜„ì¬ ì—°ì›”ë¡œ ì´ˆê¸°í™”
      filterAllHistory(); // ì´ˆê¸° ë Œë”ë§
    });
  
  
  
  
  </script>
  </body>
</html>
